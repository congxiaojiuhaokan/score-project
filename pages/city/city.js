// city.js
Page({
  data: {
    // 当前城市
    currentCity: '北京',
    // 历史访问城市
    historyCities: ['上海', '广州'],
    // 热门城市
    hotCities: ['北京', '上海', '广州', '深圳', '杭州', '成都', '武汉', '西安'],
    // 按首字母排序的城市列表
    cityList: {
      'A': ['安庆', '安阳', '鞍山', '阿拉善盟', '阿克苏地区', '阿勒泰地区', '阿里地区', '安康市'],
      'B': ['北京', '上海', '广州', '深圳', '杭州', '成都', '武汉', '西安', '重庆', '南京', '苏州市姑苏区', '天津滨海新区', '郑州市金水区', '长沙市岳麓区', '沈阳和平区', '青岛市崂山区', '济南历下区', '哈尔滨南岗区', '福州鼓楼区', '长春朝阳区'],
      'C': ['长沙', '成都', '重庆', '长春', '常州', '沧州', '赤峰市红山区', '长治市潞州区', '承德市双桥区', '郴州市北湖区'],
      'D': ['大连市甘井子区', '东莞市南城区', '德州市德城区', '东营市东营区', '大同市南郊区', '大庆市萨尔图区', '丹东市元宝区', '大理白族自治州大理市', '德阳市旌阳区', '达州市通川区'],
      'E': ['鄂尔多斯市东胜区', '鄂州市鄂城区', '恩施土家族苗族自治州恩施市', '阿坝藏族羌族自治州马尔康市'],
      'F': ['佛山市顺德区', '福州市晋安区', '阜阳市颍州区', '抚州市临川区', '阜新市海州区', '抚顺市顺城区', '防城港市港口区', '防城港市防城区'],
      'G': ['广州市天河区', '贵阳市云岩区', '桂林市象山区', '赣州市章贡区', '广元市利州区', '广安市广安区', '固原市原州区', '甘南藏族自治州合作市', '果洛藏族自治州玛沁县'],
      'H': ['杭州市西湖区', '哈尔滨市道里区', '合肥市蜀山区', '呼和浩特市新城区', '海口市美兰区', '邯郸市邯山区', '菏泽市牡丹区', '衡阳市雁峰区', '怀化市鹤城区', '黄石市黄石港区'],
      'I': [],
      'J': ['济南市市中区', '嘉兴市南湖区', '金华市婺城区', '吉林市船营区', '济宁市任城区', '荆门市东宝区', '荆州市沙市区', '景德镇市珠山区', '晋城市城区', '晋中市榆次区'],
      'K': ['昆明市五华区', '开封市龙亭区', '克拉玛依市克拉玛依区', '喀什地区喀什市', '库尔勒市库尔勒经济技术开发区', '克拉玛依市独山子区', '康定市炉城镇', '凯里市凯里经济开发区'],
      'L': ['兰州市城关区', '洛阳市洛龙区', '廊坊市广阳区', '临沂市兰山区', '连云港市海州区', '聊城市东昌府区', '柳州市柳北区', '丽江市古城区', '乐山市市中区', '泸州市江阳区'],
      'M': ['绵阳市涪城区', '茂名市茂南区', '梅州市梅江区', '马鞍山市雨山区', '眉山市东坡区', '牡丹江市东安区', '马鞍山市花山区', '茂名市电白区'],
      'N': ['南京市玄武区', '宁波市鄞州区', '南宁市青秀区', '南昌市东湖区', '南通市崇川区', '南阳市卧龙区', '南充市顺庆区', '宁德市蕉城区', '内江市市中区', '怒江傈僳族自治州泸水市'],
      'O': [],
      'P': ['青岛市市南区', '萍乡市安源区', '盘锦市兴隆台区', '平顶山市新华区', '平凉市崆峒区', '莆田市城厢区', '濮阳市华龙区', '普洱市思茅区'],
      'Q': ['青岛市黄岛区', '泉州市丰泽区', '秦皇岛市海港区', '曲靖市麒麟区', '齐齐哈尔市龙沙区', '庆阳市西峰区', '钦州市钦南区', '衢州市柯城区', '黔东南苗族侗族自治州凯里市'],
      'R': ['日照市东港区', '日喀则市桑珠孜区', '荣成市崖头街道', '瑞安市安阳街道', '乳山市城区街道'],
      'S': ['上海市浦东新区', '深圳市南山区', '苏州市工业园区', '沈阳市沈河区', '石家庄市长安区', '绍兴市越城区', '三亚市天涯区', '汕头市龙湖区', '商丘市梁园区', '十堰市茅箭区'],
      'T': ['天津市和平区', '太原市小店区', '唐山市路北区', '台州市椒江区', '泰州市海陵区', '泰安市泰山区', '铁岭市银州区', '铜川市王益区', '通辽市科尔沁区', '天水市秦州区'],
      'U': [],
      'V': [],
      'W': ['武汉市洪山区', '无锡市滨湖区', '温州市鹿城区', '潍坊市奎文区', '威海市环翠区', '乌鲁木齐市天山区', '渭南市临渭区', '芜湖市镜湖区', '梧州市万秀区', '乌兰察布市集宁区'],
      'X': ['西安市雁塔区', '厦门市思明区', '徐州市云龙区', '烟台市莱山区', '邢台市桥西区', '新乡市红旗区', '许昌市魏都区', '咸阳市秦都区', '襄阳市襄城区', '孝感市孝南区'],
      'Y': ['烟台市芝罘区', '扬州市邗江区', '盐城市亭湖区', '宜昌市西陵区', '银川市金凤区', '营口市站前区', '宜春市袁州区', '宜宾市翠屏区', '益阳市赫山区', '永州市冷水滩区'],
      'Z': ['郑州市二七区', '珠海市香洲区', '中山市东区街道', '淄博市张店区', '枣庄市薛城区', '湛江市赤坎区', '肇庆市端州区', '张家口市桥东区', '张掖市甘州区', '昭通市昭阳区']
    },
    // 26个字母
    letters: ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z'],
    // 搜索结果
    searchResult: [],
    // 搜索关键词
    searchKeyword: '',
    // 是否显示搜索结果
    showSearchResult: false,
    // 滚动到的视图id
    scrollToView: ''
  },

  // 搜索框输入变化
  onSearchInput: function(e) {
    const keyword = e.detail.value;
    this.setData({
      searchKeyword: keyword,
      showSearchResult: keyword.trim() !== ''
    });

    if (keyword.trim()) {
      this.searchCity(keyword);
    }
  },

  // 搜索城市
  searchCity: function(keyword) {
    const { cityList } = this.data;
    const searchResult = [];

    // 遍历所有城市，匹配关键词
    for (const letter in cityList) {
      const cities = cityList[letter];
      const matchedCities = cities.filter(city => {
        // 支持城市名和拼音搜索（这里简化处理，实际项目中需要拼音数据）
        return city.includes(keyword);
      });
      
      if (matchedCities.length > 0) {
        searchResult.push(...matchedCities);
      }
    }

    this.setData({
      searchResult: searchResult
    });
  },

  // 选择城市
  onSelectCity: function(e) {
    const city = e.currentTarget.dataset.city;
    console.log('选择城市:', city);
    // 保存到历史记录
    this.saveHistoryCity(city);
    // 保存到本地存储，供首页使用
    wx.setStorageSync('selectedCity', city);
    // 返回上一页
    wx.navigateBack({
      delta: 1
    });
  },

  // 保存历史访问城市
  saveHistoryCity: function(city) {
    let { historyCities } = this.data;
    // 移除已存在的城市
    historyCities = historyCities.filter(item => item !== city);
    // 添加到历史记录开头
    historyCities.unshift(city);
    // 限制历史记录数量为5条
    if (historyCities.length > 5) {
      historyCities = historyCities.slice(0, 5);
    }
    this.setData({
      historyCities: historyCities
    });
    // 保存到本地存储
    wx.setStorageSync('historyCities', historyCities);
  },

  // 点击字母导航
  onLetterTap: function(e) {
    const letter = e.currentTarget.dataset.letter;
    console.log('点击字母:', letter);
    // 滚动到对应字母的城市列表
    this.setData({
      scrollToView: 'letter-' + letter
    });
  },

  // 返回上一页
  onBackTap: function() {
    wx.navigateBack();
  }
})